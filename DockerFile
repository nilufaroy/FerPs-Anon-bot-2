FROM python:3.12-slim

ARG DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# deps for Pillow + certificates + timezone
RUN apt-get update && apt-get install -y --no-install-recommends \
    tzdata ca-certificates \
    libjpeg62-turbo libpng16-16 zlib1g \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# persistent data folder (mount volume here)
RUN mkdir -p /data

# copy bot files
COPY anon.py /app/anon.py
COPY main.py /app/main.py

# default env (you can override at runtime)
ENV DB_PATH=/data/anonymous.db
ENV PORT=8080

# optional healthcheck
HEALTHCHECK --interval=30s --timeout=10s --retries=5 \
  CMD python -c "import requests; requests.get('http://localhost:8080/health', timeout=5)" || exit 1

# Run with FastAPI webhook mode only
CMD ["python", "/app/main.py"]

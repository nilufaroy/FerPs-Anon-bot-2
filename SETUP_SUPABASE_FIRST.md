# âš¡ Supabase Database Setup (Required before running bot!)

## Step 1: Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Sign up / Log in
3. Click **New Project**
4. Fill in:
   - **Name**: FerPS Anonymous Bot (or any name)
   - **Database Password**: Create a strong password
   - **Region**: Choose closest to you
5. Click **Create New Project** and wait 2-3 minutes

## Step 2: Run the Database Schema

Your Supabase project credentials are ALREADY in `.env`. Now create the tables:

### Option A: Via Supabase Dashboard (Easiest)

1. Open [supabase.com](https://supabase.com) â†’ Your Project
2. Click **SQL Editor** â†’ **New Query**
3. Copy everything from `SUPABASE_SCHEMA.sql` (in this folder)
4. Paste into the SQL editor
5. Click **Run**

âœ… Done! Tables are created.

### Option B: Via Command Line (Advanced)

```bash
# Use psql to connect and run schema
psql "postgres://user:password@host/postgres" < SUPABASE_SCHEMA.sql
```

## Step 3: Verify Tables Created

In Supabase Dashboard:
1. Click **Table Editor**
2. You should see:
   - âœ… `settings`
   - âœ… `moderation`
   - âœ… `bans`

If not, re-run the schema.

## Step 4: Start the Bot

```bash
docker-compose up -d
```

Your bot should now start successfully! ðŸŽ‰

## Troubleshooting

### "Table doesn't exist" error
â†’ Re-run the SQL schema (Step 2)

### "Connection refused"
â†’ Check SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in .env

### Forgot the schema file?
Here's the schema creation code:

```sql
-- Run this in Supabase SQL Editor

CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS moderation (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id BIGINT NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    message_type TEXT NOT NULL,
    content_text TEXT,
    media_file_id TEXT,
    channel_username TEXT NOT NULL,
    channel_message_id BIGINT NOT NULL,
    group_message_id BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bans (
    user_id BIGINT PRIMARY KEY,
    reason TEXT,
    banned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_moderation_user_id ON moderation(user_id);
CREATE INDEX IF NOT EXISTS idx_moderation_created_at ON moderation(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_moderation_username ON moderation(username);
CREATE INDEX IF NOT EXISTS idx_moderation_channel_message ON moderation(channel_username, channel_message_id);
CREATE INDEX IF NOT EXISTS idx_bans_user_id ON bans(user_id);

ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE moderation ENABLE ROW LEVEL SECURITY;
ALTER TABLE bans ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role full access" ON settings
    FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Service role full access" ON moderation
    FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Service role full access" ON bans
    FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Anon read access" ON settings
    FOR SELECT USING (auth.role() = 'anon');
```

---

## Next Steps

After tables are created:

```bash
# Start the bot
docker-compose up -d

# View logs
docker-compose logs -f

# Test
# Send a message to your bot in Telegram
# Check Supabase Dashboard â†’ Table Editor â†’ moderation table
```

## Useful Supabase Commands

```bash
# View submission logs
SELECT * FROM moderation ORDER BY created_at DESC;

# Count submissions
SELECT COUNT(*) FROM moderation;

# Find banned users
SELECT * FROM bans;

# View bot settings
SELECT * FROM settings;
```

---

**Questions?** Check `SUPABASE_SETUP.md` for detailed info.
